<div class="character-sheet p-6">
  <div class="mb-6">
    <div class="flex justify-between items-center pb-2 border-b border-gray-300">
      <h2 class="gothic-header text-xl">{{ 'character.sheet.equipmentTitle' | dynamicTranslate }}</h2>
      <button *ngIf="!isInEditMode()" (click)="toggleEditMode()" 
              class="text-sm text-blue-600 hover:text-blue-800 transition-colors">
        {{ 'ui.actions.edit' | dynamicTranslate }}
      </button>
    </div>
    <div *ngIf="isInEditMode()" class="flex flex-col sm:flex-row gap-2 justify-center mt-3">
      <button (click)="saveCharacterData()" class="flex-1 sm:flex-none px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm sm:w-1/2 transition-colors">
        {{ 'ui.actions.save' | dynamicTranslate }}
      </button>
      <button (click)="cancelEdit()" class="flex-1 sm:flex-none px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm sm:w-1/2 transition-colors">
        {{ 'ui.actions.cancel' | dynamicTranslate }}
      </button>
    </div>
  </div>

  <!-- Equipment List as Cards -->
  <!-- View Mode: Grid layout with larger tiles for long text -->
  <div *ngIf="!isInEditMode()" class="grid gap-3 auto-rows-auto" 
       [class.lg:grid-cols-1]="character.equipment.length > 1"
       [class.xl:grid-cols-2]="character.equipment.length > 2">
    <div *ngFor="let item of character.equipment; let i = index"
        [class.hover:shadow-md]="item.note"
        [class.cursor-pointer]="item.note"
        class="group relative bg-white border border-gray-200 rounded-lg shadow-sm transition-shadow p-2"
        (click)="item.note ? openNoteModal(item) : null">
      
      <!-- Note indicator badge - Floating in top-right corner -->
      <div *ngIf="item.note" 
           class="absolute w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center shadow-sm"
           style="top: -0.5rem; right: -0.5rem;"
           title="{{ 'character.sheet.equipment.has.note' | dynamicTranslate }}">
        <svg class="w-3 h-3 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
        </svg>
      </div>
      
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0">
          <h3 class="font-medium text-gray-900 text-sm">{{ item.name }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Mode: One item per line with all buttons visible -->
  <div *ngIf="isInEditMode()" class="space-y-3">
    <div *ngFor="let item of character.equipment; let i = index" 
         class="bg-white border border-gray-200 rounded-lg shadow-sm p-4"
         appDragDrop
         [dragDropIndex]="i"
         dragDropGroup="equipment-edit"
         [attr.data-drag-index]="i"
         [attr.data-drag-group]="'equipment-edit'"
         [dragDropDisabled]="isEditingItem(i) || character.equipment.length <= 1"
         (dragDropReorder)="onReorder($event)">
      
      
      
      <!-- Normal display (not being edited) -->
      <div *ngIf="!isEditingItem(i)">
        <div class="flex gap-2 items-center justify-between mb-2">
          <button (click)="startEditItem(i)" 
                  class="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 transition-colors whitespace-nowrap">
            {{ 'ui.actions.edit' | dynamicTranslate }}
          </button>
          <button (click)="openNoteModal(item)" 
                  class="flex-1 px-3 py-2 bg-purple-500 text-white rounded text-xs hover:bg-purple-600 transition-colors whitespace-nowrap">
            {{ 'character.sheet.equipment.note.title' | dynamicTranslate}}
          </button>
          <button (click)="removeItem(i)" 
                  class="flex-1 px-3 py-2 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors">
            {{ 'ui.actions.delete' | dynamicTranslate }}
          </button>
          <div *ngIf="character.equipment.length > 1" class="flex items-center">
            <div class="text-gray-400 cursor-move drag-handle">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z"/>
              </svg>
            </div>
            <span class="text-xs text-gray-500">{{ 'ui.actions.dragToReorder' | dynamicTranslate }}</span>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <h3 class="font-medium text-gray-900 text-sm">{{ item.name }}</h3>
          <div *ngIf="item.note" class="mt-1 text-xs text-gray-500 truncate">
            {{ item.note }}
          </div>
        </div>
      </div>

      <!-- Inline edit mode -->
      <div *ngIf="isEditingItem(i)">
        <input [(ngModel)]="editingItems[i].name" 
               class="w-full p-2 border rounded text-sm mb-2"
               [placeholder]="'character.sheet.equipment.name' | dynamicTranslate"
               (keyup.enter)="saveEditItem(i)"
               (keyup.escape)="cancelEditItem(i)">
        <div class="flex gap-2">
          <button (click)="saveEditItem(i)" 
                  class="flex-1 px-3 py-2 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors">
            ✓ {{ 'ui.actions.save' | dynamicTranslate }}
          </button>
          <button (click)="cancelEditItem(i)" 
                  class="flex-1 px-3 py-2 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors">
            ✕ {{ 'ui.actions.cancel' | dynamicTranslate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- No Equipment Message -->
  <div *ngIf="character.equipment.length === 0" 
       class="text-center py-12 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
    </svg>
    <p class="text-sm italic">{{ 'character.sheet.no.equipment' | dynamicTranslate }}</p>
  </div>

  <!-- Add New Item (only in edit mode) -->
  <div *ngIf="isInEditMode()" class="mt-6 pt-4 border-t border-gray-200">
    <div class="flex gap-2">
      <input [(ngModel)]="newItemName" 
             class="flex-1 p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
             [placeholder]="'character.sheet.equipment.new.placeholder' | dynamicTranslate"
             (keyup.enter)="addItem()">
      <button (click)="addItem()" 
              class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors shadow-sm hover:shadow">
        + {{ 'ui.actions.add' | dynamicTranslate }}
      </button>
    </div>
  </div>
</div>

<!-- Equipment Note Modal -->
<app-equipment-note-modal
  [isOpen]="isNoteModalOpen"
  [item]="selectedItem"
  [isEditMode]="isInEditMode()"
  (save)="saveNote($event)"
  (close)="closeNoteModal()">
</app-equipment-note-modal>